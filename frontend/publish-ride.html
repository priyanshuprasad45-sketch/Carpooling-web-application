<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Publish a Ride - Our Ride Together</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .publish-ride {
            padding: 20px;
            text-align: center;
        }
        .publish-form {
            max-width: 500px;
            margin: 20px auto;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .publish-form label {
            display: block;
            margin: 10px 0 5px;
            text-align: left;
        }
        .publish-form input, .publish-form select {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .publish-form button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .publish-form button:hover {
            background-color: #0056b3;
        }
        .form-message {
            margin-top: 10px;
        }
        .success { color: green; }
        .error { color: red; }
        .ride-details-extra {
            margin-bottom: 15px;
            padding: 10px;
            background: #e9ecef;
            border-radius: 4px;
            text-align: left;
        }
    </style>
</head>
<body>
    <header id="main-header">
        <div class="container">
            <h1>Our Ride Together</h1>
            <nav>
                <button onclick="goToProfile()" class="btn">Profile</button>
                <button id="welcomeBtn" class="btn">Back to Welcome</button>
            </nav>
        </div>
    </header>

    <main>
        <section class="publish-ride">
            <div class="container">
                <h2>Publish a Ride</h2>
                <div id="userDetails" class="ride-details-extra"></div>
                <form id="publishRideForm" class="publish-form">
                    <label for="startingPoint">Starting Point:</label>
                    <input type="text" id="startingPoint" name="startingPoint" required>
                    <label for="destination">Destination:</label>
                    <input type="text" id="destination" name="destination" required>
                    <label for="date">Date:</label>
                    <input type="date" id="date" name="date" required>
                    <label for="time">Time:</label>
                    <input type="time" id="time" name="time" required>
                    <label for="availableSeats">Available Seats (Max 2):</label>
                    <input type="number" id="availableSeats" name="availableSeats" min="1" max="2" required>
                    <label for="price">Price (in Rupees):</label>
                    <input type="number" id="price" name="price" min="0" step="0.01" required>
                    <label for="ac">AC:</label>
                    <select id="ac" name="ac" required>
                        <option value="yes">Yes</option>
                        <option value="no">No</option>
                    </select>
                    <label for="pets_allowed">Pets Allowed:</label>
                    <select id="pets_allowed" name="pets_allowed" required>
                        <option value="yes">Yes</option>
                        <option value="no">No</option>
                    </select>
                    <button type="submit" class="btn">Publish Ride</button>
                </form>
                <p id="publishMessage" class="form-message"></p>
            </div>
        </section>
    </main>

    <footer>
        <div class="container">
            <p>Â© 2025 Our Ride Together. All rights reserved.</p>
        </div>
    </footer>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const userName = urlParams.get('name') || 'User';
        let email = urlParams.get('email');

        console.log('Publish ride page loaded with:', { userName, email });

        // Set minimum date to today
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('date').setAttribute('min', today);

        // Fetch profile to validate email if missing and display user details
        if (!email || email === 'null') {
            console.warn('No valid email in URL, attempting to fetch from profile');
            fetchProfile();
        } else {
            loadUserDetails();
        }

        async function fetchProfile() {
            try {
                const response = await fetch(`http://localhost:3000/profile?email=${encodeURIComponent(email || '')}`);
                if (response.ok) {
                    const data = await response.json();
                    email = data.email;
                    console.log('Email fetched from profile:', email);
                    loadUserDetails();
                } else {
                    console.error('Failed to fetch profile:', await response.text());
                    document.getElementById('publishMessage').textContent = 'Error: Unable to fetch profile. Please log in.';
                    document.getElementById('publishMessage').classList.add('error');
                    setTimeout(() => window.location.href = 'index.html', 2000);
                }
            } catch (error) {
                console.error('Error fetching profile:', error);
            }
        }

        async function loadUserDetails() {
            try {
                const response = await fetch(`http://localhost:3000/profile?email=${encodeURIComponent(email)}`);
                if (!response.ok) throw new Error(await response.text());
                const data = await response.json();
                document.getElementById('userDetails').innerHTML = `
                    <p><strong>Name:</strong> ${data.full_name}</p>
                    <p><strong>Mobile Number:</strong> ${data.phone}</p>
                    <p><strong>Gender:</strong> ${data.gender || 'Not specified'}</p>
                `;
            } catch (error) {
                console.error('Error loading user details:', error);
                document.getElementById('userDetails').innerHTML = `<p>Error loading details: ${error.message}</p>`;
            }
        }

        document.getElementById('publishRideForm').onsubmit = async (e) => {
            e.preventDefault();
            const message = document.getElementById('publishMessage');
            message.textContent = 'Publishing...';

            if (!email || email === 'null') {
                message.textContent = 'Error: No valid email provided. Please log in again.';
                message.classList.add('error');
                console.error('Invalid email:', email);
                setTimeout(() => window.location.href = 'index.html', 2000);
                return;
            }

            const dateInput = document.getElementById('date').value;
            const timeInput = document.getElementById('time').value;
            const rideDateTime = new Date(`${dateInput}T${timeInput}`);
            const now = new Date();

            if (rideDateTime <= now) {
                message.textContent = 'Error: Cannot publish a ride with a past date and time.';
                message.classList.add('error');
                message.classList.remove('success');
                console.error('Past date/time selected:', { rideDateTime, now });
                return;
            }

            const formData = {
                email: email,
                startingPoint: document.getElementById('startingPoint').value,
                destination: document.getElementById('destination').value,
                date: dateInput,
                time: timeInput,
                availableSeats: parseInt(document.getElementById('availableSeats').value),
                price: parseFloat(document.getElementById('price').value),
                ac: document.getElementById('ac').value,
                pets_allowed: document.getElementById('pets_allowed').value
            };

            console.log('Publishing ride with date (raw):', formData.date);

            try {
                const response = await fetch('http://localhost:3000/publish-ride', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                if (!response) {
                    throw new Error('Fetch failed: No response received from server');
                }

                const data = await response.json();
                console.log('Response:', data);

                if (!response.ok) {
                    if (response.status === 403) {
                        message.textContent = data.message + '. Redirecting to profile...';
                        setTimeout(() => {
                            window.location.href = `profile.html?name=${encodeURIComponent(userName)}&email=${encodeURIComponent(email)}`;
                        }, 2000);
                    } else {
                        throw new Error(data.message || 'Unknown error');
                    }
                    message.classList.add('error');
                    message.classList.remove('success');
                    return;
                }

                message.textContent = data.message;
                message.classList.add('success');
                message.classList.remove('error');
                document.getElementById('publishRideForm').reset();
                setTimeout(() => {
                    window.location.href = `profile.html?name=${encodeURIComponent(userName)}&email=${encodeURIComponent(email)}`;
                }, 2000);

            } catch (error) {
                console.error('Error publishing ride:', error);
                message.textContent = 'Error publishing ride: ' + error.message;
                message.classList.add('error');
                message.classList.remove('success');
            }
        };

        function goToProfile() {
            console.log('Navigating back to profile with:', { userName, email });
            window.location.href = `profile.html?name=${encodeURIComponent(userName)}&email=${encodeURIComponent(email)}`;
        }

        document.getElementById('welcomeBtn').onclick = () => {
            if (!email || email === 'null') {
                console.error('No valid email for welcome navigation, redirecting to login');
                window.location.href = 'index.html';
                return;
            }
            console.log('Returning to welcome with:', { userName, email });
            window.location.href = `welcome.html?name=${encodeURIComponent(userName)}&email=${encodeURIComponent(email)}`;
        };

        
    </script>
</body>
</html>